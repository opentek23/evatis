<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Recharge Simple</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#2196F3">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Scanner Evatis">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5; color: #333; min-height: 100vh;
            padding: 20px;
        }
        
        .app { max-width: 400px; margin: 0 auto; }
        
        .header { 
            text-align: center; margin-bottom: 30px; 
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { color: #2196F3; font-size: 24px; margin-bottom: 5px; }
        .header p { color: #666; font-size: 14px; }
        
        .card { 
            background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .input-section { margin-bottom: 20px; }
        .input-section h3 { margin-bottom: 15px; color: #333; }
        
        .code-input {
            width: 100%; padding: 15px; font-size: 18px; text-align: center;
            border: 2px solid #ddd; border-radius: 10px; margin-bottom: 15px;
            letter-spacing: 2px; font-weight: bold;
        }
        .code-input:focus { 
            outline: none; border-color: #2196F3; 
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }
        .code-input.valid { border-color: #4CAF50; background: #f1f8e9; }
        
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 10px; 
            font-size: 16px; font-weight: 600; cursor: pointer; 
            margin-bottom: 10px; transition: all 0.3s ease;
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-secondary { background: #f5f5f5; color: #333; border: 1px solid #ddd; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn.hidden { display: none; }
        
        .camera-section { margin-bottom: 20px; }
        .camera-container { 
            background: #000; border-radius: 15px; aspect-ratio: 4/3; 
            position: relative; overflow: hidden; display: none;
        }
        .camera-container.active { display: block; }
        
        video { width: 100%; height: 100%; object-fit: cover; }
        
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border: 3px dashed #2196F3; width: 80%; height: 40%; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(33, 150, 243, 0.1);
        }
        .overlay-text { 
            background: rgba(33, 150, 243, 0.9); color: white; 
            padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
        }
        
        .result { 
            background: linear-gradient(135deg, #4CAF50, #45a049); 
            color: white; border-radius: 15px; padding: 25px; text-align: center;
            display: none; animation: slideUp 0.4s ease;
        }
        .result.active { display: block; }
        .result h3 { margin-bottom: 15px; font-size: 18px; }
        .detected-code { 
            background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px;
            font-family: monospace; font-size: 20px; font-weight: bold;
            letter-spacing: 3px; margin-bottom: 20px;
        }
        
        .auto-call {
            background: #FF5722; color: white; border-radius: 10px; 
            padding: 15px; margin: 20px 0; text-align: center;
            display: none; animation: pulse 1s infinite;
        }
        .auto-call.active { display: block; }
        .countdown { font-size: 24px; font-weight: bold; }
        
        .example-section {
            background: #e3f2fd; border-radius: 10px; padding: 15px; margin-bottom: 20px;
        }
        .example-section h4 { color: #1976d2; margin-bottom: 10px; }
        .example-code { 
            background: white; padding: 10px; border-radius: 5px; 
            font-family: monospace; font-size: 16px; text-align: center; 
            letter-spacing: 2px; border: 1px solid #2196F3;
        }
        
        .quick-buttons {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
        }
        
        @keyframes slideUp { 
            from { transform: translateY(20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        
        /* Responsive */
        @media (max-width: 480px) {
            body { padding: 10px; }
            .header { padding: 15px; }
            .detected-code { font-size: 18px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üì± Scanner Recharge</h1>
            <p>Simple et efficace</p>
        </div>

        <!-- Exemple -->
        <div class="example-section">
            <h4>üéØ Exemple de code √† saisir :</h4>
            <div class="example-code">990843980281</div>
        </div>

        <!-- Saisie rapide -->
        <div class="card">
            <div class="input-section">
                <h3>‚úèÔ∏è Saisie Rapide</h3>
                <input id="codeInput" class="code-input" 
                       placeholder="12 chiffres de votre carte"
                       type="tel" inputmode="numeric" maxlength="12">
                <button id="callBtn" class="btn btn-success" disabled>
                    üìû Recharger Maintenant
                </button>
            </div>
        </div>

        <!-- Scanner cam√©ra -->
        <div class="card">
            <div class="camera-section">
                <h3>üì∑ Scanner avec Cam√©ra</h3>
                <div id="cameraContainer" class="camera-container">
                    <video id="video" autoplay playsinline muted></video>
                    <div class="overlay">
                        <div class="overlay-text">Positionnez les 12 chiffres ici</div>
                    </div>
                </div>
                <button id="startCameraBtn" class="btn btn-primary">
                    üì∑ Ouvrir Cam√©ra
                </button>
                <button id="stopCameraBtn" class="btn btn-secondary hidden">
                    ‚èπÔ∏è Fermer Cam√©ra
                </button>
            </div>
        </div>

        <!-- Auto-call notification -->
        <div id="autoCall" class="auto-call">
            <div>üöÄ Appel automatique dans</div>
            <div id="countdown" class="countdown">3</div>
            <div style="font-size: 12px; margin-top: 5px;">Tapez pour annuler</div>
        </div>

        <!-- R√©sultat -->
        <div id="result" class="result">
            <h3>‚úÖ Code Pr√™t !</h3>
            <div id="detectedCode" class="detected-code"></div>
            <div class="quick-buttons">
                <button id="confirmCallBtn" class="btn btn-success">
                    üìû Appeler
                </button>
                <button id="copyBtn" class="btn btn-secondary">
                    üìã Copier
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let stream = null;
        let cameraActive = false;
        let detectedCode = '';
        let scanInterval = null;

        // √âl√©ments DOM
        const elements = {
            codeInput: document.getElementById('codeInput'),
            callBtn: document.getElementById('callBtn'),
            cameraContainer: document.getElementById('cameraContainer'),
            video: document.getElementById('video'),
            startCameraBtn: document.getElementById('startCameraBtn'),
            stopCameraBtn: document.getElementById('stopCameraBtn'),
            autoCall: document.getElementById('autoCall'),
            countdown: document.getElementById('countdown'),
            result: document.getElementById('result'),
            detectedCode: document.getElementById('detectedCode'),
            confirmCallBtn: document.getElementById('confirmCallBtn'),
            copyBtn: document.getElementById('copyBtn')
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            attachEventListeners();
            console.log('üì± Scanner Simple initialis√©');
        });

        // VALIDATION EN TEMPS R√âEL
        function validateInput() {
            let value = elements.codeInput.value.replace(/\D/g, '');
            if (value.length > 12) value = value.substring(0, 12);
            
            elements.codeInput.value = value;
            
            if (value.length === 12) {
                elements.codeInput.classList.add('valid');
                elements.callBtn.disabled = false;
                elements.callBtn.textContent = `üìû Recharger ${value}`;
                
                // Auto-d√©clenchement si 12 chiffres complets
                if (value !== detectedCode) {
                    detectedCode = value;
                    triggerAutoCall();
                }
            } else {
                elements.codeInput.classList.remove('valid');
                elements.callBtn.disabled = true;
                elements.callBtn.textContent = 'üìû Recharger Maintenant';
            }
        }

        // CAM√âRA SIMPLE
        async function startCamera() {
            try {
                // Contraintes simples
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.video.srcObject = stream;
                
                cameraActive = true;
                elements.cameraContainer.classList.add('active');
                elements.startCameraBtn.classList.add('hidden');
                elements.stopCameraBtn.classList.remove('hidden');
                
                // Scanner simple toutes les 3 secondes
                startSimpleScan();
                
                vibrate(50);
                
            } catch (error) {
                alert('‚ùå Impossible d\'acc√©der √† la cam√©ra. Utilisez la saisie manuelle.');
                console.error('Erreur cam√©ra:', error);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            cameraActive = false;
            elements.cameraContainer.classList.remove('active');
            elements.startCameraBtn.classList.remove('hidden');
            elements.stopCameraBtn.classList.add('hidden');
        }

        // SCAN SIMPLE avec OCR.space
        function startSimpleScan() {
            scanInterval = setInterval(async () => {
                if (!cameraActive) return;
                
                try {
                    // Capturer frame
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = elements.video.videoWidth || 640;
                    canvas.height = elements.video.videoHeight || 480;
                    
                    ctx.drawImage(elements.video, 0, 0);
                    const imageData = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // OCR simple
                    const response = await fetch('https://api.ocr.space/parse/image', {
                        method: 'POST',
                        headers: { 'apikey': 'K87899142388957' },
                        body: (() => {
                            const formData = new FormData();
                            formData.append('base64Image', imageData);
                            formData.append('language', 'eng');
                            return formData;
                        })()
                    });

                    const result = await response.json();
                    if (result.ParsedResults && result.ParsedResults[0]) {
                        const text = result.ParsedResults[0].ParsedText || '';
                        const numbers = text.replace(/\D/g, '');
                        
                        console.log('üì∏ Scan:', numbers);
                        
                        // Si exactement 12 chiffres
                        if (numbers.length >= 12) {
                            const code = numbers.substring(0, 12);
                            elements.codeInput.value = code;
                            validateInput();
                            stopCamera();
                            vibrate([100, 50, 100]);
                        }
                    }
                    
                } catch (error) {
                    console.log('Scan error:', error);
                }
            }, 3000);
        }

        // APPEL AUTOMATIQUE
        function triggerAutoCall() {
            elements.autoCall.classList.add('active');
            let timeLeft = 3;
            
            const countdownInterval = setInterval(() => {
                elements.countdown.textContent = timeLeft;
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    elements.autoCall.classList.remove('active');
                    makeCall();
                }
            }, 1000);
            
            // Annuler en tapant
            elements.autoCall.onclick = () => {
                clearInterval(countdownInterval);
                elements.autoCall.classList.remove('active');
            };
        }

        function makeCall() {
            if (!detectedCode || detectedCode.length !== 12) {
                alert('‚ùå Code invalide');
                return;
            }
            
            // Afficher r√©sultat d'abord
            showResult();
            
            // Appel direct
            const phoneNumber = `*166*${detectedCode}#`;
            console.log('üìû Appel:', phoneNumber);
            
            try {
                window.location.href = `tel:${phoneNumber}`;
                vibrate(200);
            } catch (error) {
                console.error('Erreur appel:', error);
            }
        }

        function showResult() {
            elements.detectedCode.textContent = detectedCode;
            elements.result.classList.add('active');
        }

        async function copyCode() {
            try {
                await navigator.clipboard.writeText(detectedCode);
                elements.copyBtn.textContent = '‚úÖ Copi√©!';
                setTimeout(() => {
                    elements.copyBtn.textContent = 'üìã Copier';
                }, 2000);
                vibrate(50);
            } catch (error) {
                console.error('Erreur copie:', error);
            }
        }

        function vibrate(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        // Event Listeners
        function attachEventListeners() {
            elements.codeInput.oninput = validateInput;
            elements.callBtn.onclick = () => {
                detectedCode = elements.codeInput.value;
                triggerAutoCall();
            };
            elements.startCameraBtn.onclick = startCamera;
            elements.stopCameraBtn.onclick = stopCamera;
            elements.confirmCallBtn.onclick = makeCall;
            elements.copyBtn.onclick = copyCode;
            
            // Auto-focus sur input
            elements.codeInput.focus();
            
            // Raccourci Enter
            elements.codeInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !elements.callBtn.disabled) {
                    elements.callBtn.click();
                }
            });
        }

        // Nettoyage
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>