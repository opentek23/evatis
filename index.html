<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Recharge Evatis</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#674eff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scanner Evatis">
    
    <!-- Manifest PWA -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2Nhbm5lciBSZWNoYXJnZSBFdmF0aXMiLCJzaG9ydF9uYW1lIjoiU2Nhbm5lciIsInN0YXJ0X3VybCI6Ii4vIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2NzRlZmYiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDE5MiAxOTInJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzNjc0ZWZmJyByeD0nMjQnLyUzRSUzQ3RleHQgeD0nOTYnIHk9JzEzMCcgZm9udC1zaXplPScxMDAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9J3doaXRlJyUzRSUyMyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDUxMiA1MTInJTNFJTNDcmVjdCB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgZmlsbD0nJTIzNjc0ZWZmJyByeD0nNjQnLyUzRSUzQ3RleHQgeD0nMjU2JyB5PSczNTAnIGZvbnQtc2l6ZT0nMjgwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0UlMjMlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff; color: #333; min-height: 100vh; 
            -webkit-text-size-adjust: 100%; -webkit-font-smoothing: antialiased;
        }
        
        .app { max-width: 450px; margin: 0 auto; padding: 15px; min-height: 100vh; }
        
        .header { 
            text-align: center; margin-bottom: 20px; padding: 20px; 
            background: linear-gradient(135deg, rgba(103, 78, 255, 0.1), rgba(240, 147, 251, 0.1));
            border-radius: 15px; border: 1px solid rgba(103, 78, 255, 0.2);
        }
        .header h1 { 
            background: linear-gradient(45deg, #674eff, #f093fb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; font-size: 24px; margin-bottom: 8px; font-weight: 700;
        }
        .header p { color: #666; font-size: 14px; }
        
        .card { 
            background: #fff; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            margin-bottom: 20px; overflow: hidden; 
        }
        .card img { width: 100%; height: auto; display: block; }
        
        .camera-section { margin: 20px 0; }
        .camera-container { 
            background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 15px; 
            aspect-ratio: 4/3; position: relative; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden;
            display: none;
        }
        .camera-container.active { display: block; }
        
        video, canvas { 
            width: 100%; height: 100%; object-fit: cover; border-radius: 13px;
            background: #000;
        }
        
        /* Overlay avec crochets de visée - SIMPLIFIÉ */
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 40%; border: 2px dashed #674eff; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(103, 78, 255, 0.1); backdrop-filter: blur(5px);
        }
        
        /* Crochets aux 4 coins - VERSION SIMPLE */
        .overlay::before,
        .overlay::after {
            content: '';
            position: absolute;
            width: 30px; height: 30px;
            border: 3px solid #674eff;
        }
        .overlay::before {
            top: -3px; left: -3px;
            border-right: none; border-bottom: none;
        }
        .overlay::after {
            top: -3px; right: -3px;
            border-left: none; border-bottom: none;
        }
        
        .corner-bl, .corner-br {
            position: absolute; width: 30px; height: 30px;
            border: 3px solid #674eff;
        }
        .corner-bl {
            bottom: -3px; left: -3px;
            border-right: none; border-top: none;
        }
        .corner-br {
            bottom: -3px; right: -3px;
            border-left: none; border-top: none;
        }
        
        .overlay-text { 
            background: rgba(103, 78, 255, 0.9); color: white; padding: 8px 12px; 
            border-radius: 8px; font-size: 12px; text-align: center; font-weight: 600;
            white-space: nowrap; z-index: 5; position: relative;
        }
        
        .controls { 
            display: flex; gap: 10px; flex-direction: column; margin: 20px 0; 
        }
        
        .btn {
            padding: 16px; border: none; border-radius: 12px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s ease; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 56px;
        }
        .btn-primary { 
            background: linear-gradient(45deg, #674eff, #f093fb); color: white; 
            box-shadow: 0 4px 15px rgba(103, 78, 255, 0.3);
        }
        .btn-secondary { 
            background: #f8f9fa; color: #495057; border: 2px solid #dee2e6; 
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn.hidden { display: none; }
        
        .manual-input { 
            background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0;
            display: none;
        }
        .manual-input.active { display: block; }
        .manual-input input {
            width: 100%; padding: 16px; border: 2px solid #dee2e6; border-radius: 8px;
            font-size: 18px; margin-bottom: 15px; text-align: center; letter-spacing: 1px;
        }
        .manual-input input:focus { 
            outline: none; border-color: #674eff; 
            box-shadow: 0 0 0 3px rgba(103, 78, 255, 0.1); 
        }
        
        .status { 
            text-align: center; padding: 15px; border-radius: 10px; margin: 15px 0; 
            font-weight: 500; font-size: 14px; display: none;
        }
        .status.active { display: block; }
        .status.processing { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .result { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            border: 2px solid #674eff; border-radius: 15px; 
            padding: 25px; text-align: center; margin: 20px 0;
            box-shadow: 0 8px 25px rgba(103, 78, 255, 0.2);
            display: none;
        }
        .result.active { display: block; animation: slideUp 0.4s ease; }
        .result-title { 
            color: #674eff; font-size: 18px; font-weight: 600; margin-bottom: 15px;
        }
        .detected-code { 
            background: #fff; padding: 20px; border-radius: 10px; 
            font-family: 'Courier New', monospace; font-size: 20px; font-weight: bold;
            letter-spacing: 2px; margin-bottom: 20px; border: 2px solid #674eff;
            color: #333; word-break: break-all;
        }
        
        .footer { 
            text-align: center; margin-top: 30px; padding: 20px; color: #666; 
            border-top: 1px solid #e9ecef; font-size: 14px;
        }
        .footer a { color: #674eff; text-decoration: none; font-weight: 600; }
        
        /* Animations */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .pulse { animation: pulse 1.5s infinite; }
        
        @keyframes slideUp { 
            from { transform: translateY(20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        /* Auto-call notification */
        .auto-call-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #674eff; color: white; padding: 15px 20px;
            border-radius: 10px; font-weight: 600; z-index: 1000;
            box-shadow: 0 4px 20px rgba(103, 78, 255, 0.4);
            display: none; animation: slideDown 0.3s ease;
        }
        .auto-call-notification.active { display: block; }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }
        
        /* Responsive */
        @media (max-width: 480px) {
            .app { padding: 10px; }
            .header { margin-bottom: 15px; padding: 15px; }
            .detected-code { font-size: 18px; padding: 15px; }
            .overlay-text { font-size: 11px; padding: 6px 10px; }
        }
        
        /* iOS Safari fixes */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            video { -webkit-transform: translateZ(0); transform: translateZ(0); }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>📱 Scanner Recharge</h1>
            <p>Scannez et rechargez automatiquement</p>
        </div>

        <!-- Carte Evatis -->
        <div class="card">
            <img id="evatisImg" src="evatis.jpg" alt="Carte Evatis" 
                 onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 250\'><rect width=\'400\' height=\'250\' fill=\'%23DAA520\'/><text x=\'200\' y=\'120\' text-anchor=\'middle\' fill=\'white\' font-size=\'20\' font-weight=\'bold\'>CARTE EVATIS</text><text x=\'200\' y=\'150\' text-anchor=\'middle\' fill=\'white\' font-size=\'32\' font-weight=\'bold\'>2000 FDJ</text></svg>'">
        </div>

        <!-- Section Caméra -->
        <div class="camera-section">
            <div id="cameraContainer" class="camera-container">
                <video id="video" autoplay playsinline webkit-playsinline muted></video>
                <canvas id="canvas" style="display: none;"></canvas>
                
                <!-- Overlay avec crochets de visée -->
                <div id="overlay" class="overlay">
                    <div class="corner-bl"></div>
                    <div class="corner-br"></div>
                    <div class="overlay-text">
                        📱 Alignez les 12 chiffres ici
                    </div>
                </div>
            </div>

            <!-- Contrôles -->
            <div class="controls">
                <button id="startCameraBtn" class="btn btn-primary">
                    📷 Ouvrir Scanner
                </button>
                
                <button id="captureBtn" class="btn btn-primary hidden">
                    📸 Capturer Photo
                </button>
                
                <button id="processBtn" class="btn btn-primary hidden">
                    🔍 Scanner Automatiquement
                </button>
                
                <button id="processingBtn" class="btn btn-primary pulse hidden" disabled>
                    ⏳ <span id="processingText">Analyse...</span>
                </button>
                
                <button id="retakeBtn" class="btn btn-secondary hidden">
                    🔄 Recommencer
                </button>
                
                <button id="manualBtn" class="btn btn-secondary">
                    ✏️ Saisie Manuelle
                </button>
            </div>
        </div>

        <!-- Saisie manuelle -->
        <div id="manualInput" class="manual-input">
            <input id="manualCode" 
                   placeholder="12 chiffres de la carte"
                   maxlength="12"
                   type="tel"
                   inputmode="numeric">
            <button id="useManualBtn" class="btn btn-primary" disabled>
                ✅ Utiliser Code
            </button>
        </div>

        <!-- Statut -->
        <div id="status" class="status"></div>

        <!-- Résultat -->
        <div id="result" class="result">
            <div class="result-title">✅ Code Détecté avec Succès</div>
            <div id="detectedCode" class="detected-code"></div>
            <div class="controls">
                <button id="callBtn" class="btn btn-primary">
                    📞 Appeler *166*
                </button>
                <button id="copyBtn" class="btn btn-secondary">
                    📋 Copier Code
                </button>
            </div>
        </div>

        <!-- Notification d'appel automatique -->
        <div id="autoCallNotification" class="auto-call-notification">
            🚀 Appel automatique dans <span id="countdown">3</span>s...
        </div>

        <div class="footer">
            <p>Création d'<a href="https://opentek.co/" target="_blank">Opentek</a></p>
        </div>
    </div>

    <script>
        // Variables globales
        let stream = null;
        let cameraActive = false;
        let capturedImage = false;
        let processing = false;
        let detectedCodeValue = '';

        // Éléments DOM
        const elements = {
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            cameraContainer: document.getElementById('cameraContainer'),
            overlay: document.getElementById('overlay'),
            startCameraBtn: document.getElementById('startCameraBtn'),
            captureBtn: document.getElementById('captureBtn'),
            processBtn: document.getElementById('processBtn'),
            processingBtn: document.getElementById('processingBtn'),
            processingText: document.getElementById('processingText'),
            retakeBtn: document.getElementById('retakeBtn'),
            manualBtn: document.getElementById('manualBtn'),
            manualInput: document.getElementById('manualInput'),
            manualCode: document.getElementById('manualCode'),
            useManualBtn: document.getElementById('useManualBtn'),
            status: document.getElementById('status'),
            result: document.getElementById('result'),
            detectedCode: document.getElementById('detectedCode'),
            callBtn: document.getElementById('callBtn'),
            copyBtn: document.getElementById('copyBtn'),
            autoCallNotification: document.getElementById('autoCallNotification'),
            countdown: document.getElementById('countdown')
        };

        // Initialisation PWA
        document.addEventListener('DOMContentLoaded', function() {
            initializePWA();
            attachEventListeners();
            console.log('📱 Scanner Evatis initialisé');
        });

        function initializePWA() {
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'evatis-scanner-v7';
                    const ASSETS = [
                        './',
                        './index.html',
                        './evatis.jpg'
                    ];
                    
                    self.addEventListener('install', event => {
                        console.log('📦 SW Installing...');
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(ASSETS))
                                .catch(err => console.log('Cache error:', err))
                        );
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                                .catch(err => {
                                    console.log('Fetch offline');
                                    return new Response('App disponible hors ligne', { 
                                        status: 503,
                                        headers: { 'Content-Type': 'text/plain' }
                                    });
                                })
                        );
                    });
                    
                    self.addEventListener('activate', event => {
                        console.log('✅ SW Activated');
                        event.waitUntil(clients.claim());
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(reg => {
                        console.log('✅ PWA installé:', reg.scope);
                        showStatus('📱 App prête pour installation', 'success');
                    })
                    .catch(err => console.log('❌ PWA erreur:', err));
            }
        }

        // Utilitaires
        function showStatus(message, type = 'processing', duration = 3000) {
            elements.status.textContent = message;
            elements.status.className = `status active ${type}`;
            
            if (duration > 0) {
                setTimeout(() => {
                    elements.status.classList.remove('active');
                }, duration);
            }
        }

        function vibrate(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        function toggleElement(element, show) {
            if (show) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        // Détection plateforme
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);

        console.log('📱 Plateforme:', { isIOS, isAndroid, isSafari });

        // GESTION CAMÉRA
        async function startCamera() {
            try {
                showStatus('Demande autorisation caméra...', 'processing');
                
                const constraints = {
                    video: {
                        facingMode: { exact: 'environment' },
                        width: { ideal: 1920, min: 640 },
                        height: { ideal: 1080, min: 480 },
                        frameRate: { ideal: 30, min: 15 }
                    },
                    audio: false
                };

                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    console.log('✅ Caméra avec contraintes complètes');
                } catch (error) {
                    console.log('❌ Essai 1 échoué, fallback...', error.name);
                    const fallbackConstraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280, min: 640 },
                            height: { ideal: 720, min: 480 }
                        },
                        audio: false
                    };
                    stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                    console.log('✅ Caméra avec fallback');
                }

                elements.video.srcObject = stream;
                elements.video.setAttribute('playsinline', 'true');
                elements.video.setAttribute('webkit-playsinline', 'true');
                elements.video.muted = true;
                
                await elements.video.play();

                cameraActive = true;
                elements.cameraContainer.classList.add('active');
                
                toggleElement(elements.startCameraBtn, false);
                toggleElement(elements.captureBtn, true);
                
                showStatus('✅ Caméra active - Alignez votre carte', 'success');
                vibrate(50);

            } catch (error) {
                console.error('❌ Erreur caméra complète:', error);
                
                const errorMessages = {
                    'NotAllowedError': '❌ Veuillez autoriser l\'accès à la caméra',
                    'NotFoundError': '❌ Aucune caméra trouvée',
                    'NotSupportedError': '❌ Caméra non supportée',
                    'OverconstrainedError': '❌ Contraintes caméra incompatibles',
                    'NotReadableError': '❌ Caméra utilisée par une autre app'
                };

                const message = errorMessages[error.name] || `❌ Erreur: ${error.message}`;
                showStatus(message, 'error', 0);
                
                setTimeout(() => {
                    if (isIOS) {
                        showStatus('💡 iPhone: Utilisez Safari et autorisez la caméra', 'error', 0);
                    } else if (isAndroid) {
                        showStatus('💡 Android: Utilisez Chrome et autorisez la caméra', 'error', 0);
                    }
                }, 2000);
            }
        }

        function capturePhoto() {
            const ctx = elements.canvas.getContext('2d');
            elements.canvas.width = elements.video.videoWidth || 1280;
            elements.canvas.height = elements.video.videoHeight || 720;
            
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(elements.video, 0, 0);
            
            elements.video.style.display = 'none';
            elements.canvas.style.display = 'block';
            elements.overlay.style.display = 'none';
            
            capturedImage = true;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            toggleElement(elements.captureBtn, false);
            toggleElement(elements.processBtn, true);
            toggleElement(elements.retakeBtn, true);
            
            showStatus('📸 Photo capturée avec succès', 'success');
            vibrate([50, 30, 50]);
        }

        function retakePhoto() {
            elements.video.style.display = 'block';
            elements.canvas.style.display = 'none';
            elements.overlay.style.display = 'flex';
            elements.result.classList.remove('active');
            
            capturedImage = false;
            processing = false;
            detectedCodeValue = '';
            
            toggleElement(elements.processBtn, false);
            toggleElement(elements.processingBtn, false);
            toggleElement(elements.retakeBtn, false);
            
            startCamera();
        }

        // OCR SIMPLE ET RAPIDE avec OCR.space API (gratuite)
        async function processImage() {
            processing = true;
            toggleElement(elements.processBtn, false);
            toggleElement(elements.processingBtn, true);
            elements.processingText.textContent = 'Conversion image...';
            
            showStatus('🔍 Préparation de l\'analyse...', 'processing', 0);

            try {
                // Convertir canvas en base64
                const imageData = elements.canvas.toDataURL('image/jpeg', 0.8);
                
                elements.processingText.textContent = 'Analyse en cours...';
                showStatus('🤖 Reconnaissance des chiffres...', 'processing', 0);

                // Utilisation d'OCR.space API (gratuite - 500 calls/mois)
                const formData = new FormData();
                formData.append('base64Image', imageData);
                formData.append('language', 'eng');
                formData.append('isOverlayRequired', 'false');
                formData.append('iscreatesearchablepdf', 'false');
                formData.append('issearchablepdfhidetextlayer', 'false');

                const response = await fetch('https://api.ocr.space/parse/image', {
                    method: 'POST',
                    headers: {
                        'apikey': 'K87899142388957'  // Clé gratuite OCR.space
                    },
                    body: formData
                });

                const result = await response.json();
                console.log('📝 OCR Result:', result);

                if (result.ParsedResults && result.ParsedResults.length > 0) {
                    const extractedText = result.ParsedResults[0].ParsedText || '';
                    const numbers = extractedText.replace(/\D/g, '');
                    
                    console.log('🔢 Texte extrait:', extractedText);
                    console.log('🔢 Chiffres trouvés:', numbers);
                    
                    processing = false;
                    toggleElement(elements.processingBtn, false);
                    
                    if (numbers.length >= 12) {
                        detectedCodeValue = numbers.substring(0, 12);
                        elements.detectedCode.textContent = `[${detectedCodeValue}]`;
                        elements.result.classList.add('active');
                        
                        showStatus('✅ Code détecté avec succès!', 'success');
                        vibrate([100, 50, 100, 50, 100]);
                        
                        // APPEL AUTOMATIQUE APRÈS DÉTECTION
                        startAutoCall();
                        
                    } else if (numbers.length > 0) {
                        showStatus(`⚠️ ${numbers.length} chiffres trouvés (12 requis). Essayez la saisie manuelle.`, 'error');
                        toggleElement(elements.processBtn, true);
                    } else {
                        showStatus('❌ Aucun chiffre détecté. Utilisez la saisie manuelle.', 'error');
                        toggleElement(elements.processBtn, true);
                    }
                } else {
                    throw new Error('Aucun texte détecté');
                }
                
            } catch (error) {
                processing = false;
                toggleElement(elements.processingBtn, false);
                toggleElement(elements.processBtn, true);
                console.error('❌ Erreur OCR:', error);
                showStatus('❌ Erreur de reconnaissance. Utilisez la saisie manuelle.', 'error');
            }
        }

        // APPEL AUTOMATIQUE avec compte à rebours
        function startAutoCall() {
            elements.autoCallNotification.classList.add('active');
            let timeLeft = 3;
            
            const countdownInterval = setInterval(() => {
                elements.countdown.textContent = timeLeft;
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    elements.autoCallNotification.classList.remove('active');
                    makeCall();
                }
            }, 1000);
            
            // Permettre d'annuler en cliquant
            elements.autoCallNotification.onclick = () => {
                clearInterval(countdownInterval);
                elements.autoCallNotification.classList.remove('active');
                showStatus('⏹️ Appel automatique annulé', 'error');
            };
        }

        // Gestion saisie manuelle
        function toggleManualInput() {
            const isActive = elements.manualInput.classList.contains('active');
            
            if (isActive) {
                elements.manualInput.classList.remove('active');
            } else {
                elements.manualInput.classList.add('active');
                elements.manualCode.value = '';
                elements.manualCode.focus();
            }
        }

        function validateManualInput() {
            const value = elements.manualCode.value.replace(/\D/g, '').substring(0, 12);
            elements.manualCode.value = value;
            elements.useManualBtn.disabled = value.length !== 12;
        }

        function useManualCode() {
            detectedCodeValue = elements.manualCode.value;
            elements.detectedCode.textContent = `[${detectedCodeValue}]`;
            elements.result.classList.add('active');
            elements.manualInput.classList.remove('active');
            
            showStatus('✅ Code saisi manuellement', 'success');
            
            // APPEL AUTO AUSSI POUR SAISIE MANUELLE
            startAutoCall();
        }

        // Actions
        function makeCall() {
            const phoneNumber = `*166*${detectedCodeValue}#`;
            console.log('📞 Appel:', phoneNumber);
            
            try {
                window.location.href = `tel:${phoneNumber}`;
                showStatus('📞 Ouverture téléphone...', 'success');
                vibrate(200);
            } catch (error) {
                showStatus('❌ Impossible d\'ouvrir téléphone', 'error');
            }
        }

        async function copyCode() {
            const textToCopy = `[${detectedCodeValue}]`;
            
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(textToCopy);
                } else {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = textToCopy;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    textArea.remove();
                }
                
                showStatus('📋 Code copié dans le presse-papiers!', 'success');
                vibrate(50);
                
            } catch (error) {
                showStatus('❌ Erreur de copie', 'error');
            }
        }

        // Event Listeners
        function attachEventListeners() {
            elements.startCameraBtn.onclick = startCamera;
            elements.captureBtn.onclick = capturePhoto;
            elements.processBtn.onclick = processImage;
            elements.retakeBtn.onclick = retakePhoto;
            elements.manualBtn.onclick = toggleManualInput;
            elements.manualCode.oninput = validateManualInput;
            elements.useManualBtn.onclick = useManualCode;
            elements.callBtn.onclick = makeCall;
            elements.copyBtn.onclick = copyCode;
            elements.canvas.onclick = retakePhoto;
            
            // Raccourcis clavier
            document.addEventListener('keydown', e => {
                if (e.key === 'Enter' && elements.manualInput.classList.contains('active')) {
                    if (!elements.useManualBtn.disabled) useManualCode();
                }
                if (e.key === 'Escape') {
                    if (elements.manualInput.classList.contains('active')) toggleManualInput();
                }
            });
        }

        // Gestion erreurs globales
        window.addEventListener('error', e => {
            console.error('❌ Erreur globale:', e.error);
            showStatus('❌ Une erreur est survenue', 'error');
        });

        window.addEventListener('unhandledrejection', e => {
            console.error('❌ Promise rejetée:', e.reason);
            showStatus('❌ Erreur de traitement', 'error');
        });
    </script>
</body>
</html>