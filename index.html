<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Recharge Evatis</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#674eff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scanner Evatis">
    
    <!-- Manifest PWA intégré -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2Nhbm5lciBSZWNoYXJnZSBFdmF0aXMiLCJzaG9ydF9uYW1lIjoiU2Nhbm5lciIsInN0YXJ0X3VybCI6Ii4vIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2NzRlZmYiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDE5MiAxOTInJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzNjc0ZWZmJyByeD0nMjQnLyUzRSUzQ3RleHQgeD0nOTYnIHk9JzEzMCcgZm9udC1zaXplPScxMDAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9J3doaXRlJyUzRSUyMyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn0seyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDUxMiA1MTInJTNFJTNDcmVjdCB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgZmlsbD0nJTIzNjc0ZWZmJyByeD0nNjQnLyUzRSUzQ3RleHQgeD0nMjU2JyB5PSczNTAnIGZvbnQtc2l6ZT0nMjgwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBmaWxsPSd3aGl0ZSclM0UlMjMlM0MvdGV4dCUzRSUzQy9zdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #ffffff; color: #333; min-height: 100vh; 
            -webkit-text-size-adjust: 100%; -webkit-font-smoothing: antialiased;
        }
        
        .app { max-width: 450px; margin: 0 auto; padding: 15px; min-height: 100vh; }
        
        .header { 
            text-align: center; margin-bottom: 20px; padding: 20px; 
            background: linear-gradient(135deg, rgba(103, 78, 255, 0.1), rgba(240, 147, 251, 0.1));
            border-radius: 15px; border: 1px solid rgba(103, 78, 255, 0.2);
        }
        .header h1 { 
            background: linear-gradient(45deg, #674eff, #f093fb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; font-size: 24px; margin-bottom: 8px; font-weight: 700;
        }
        .header p { color: #666; font-size: 14px; }
        
        .card { 
            background: #fff; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            margin-bottom: 20px; overflow: hidden; 
        }
        .card img { width: 100%; height: auto; display: block; }
        
        .camera-section { margin: 20px 0; }
        .camera-container { 
            background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 15px; 
            aspect-ratio: 4/3; position: relative; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden;
        }
        
        /* Important pour mobile */
        video, canvas { 
            width: 100%; height: 100%; object-fit: cover; border-radius: 13px;
            background: #000; /* Fond noir pour éviter le flash */
        }
        
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 45%; z-index: 10;
        }
        
        .target-frame {
            width: 100%; height: 100%; position: relative;
            border: 2px dashed #674eff; border-radius: 12px;
            background: rgba(103, 78, 255, 0.1); backdrop-filter: blur(3px);
        }
        
        /* Crochets aux coins */
        .corner { position: absolute; width: 25px; height: 25px; }
        .corner::before, .corner::after {
            content: ''; position: absolute; background: #674eff;
        }
        .corner.tl { top: -2px; left: -2px; }
        .corner.tl::before { width: 15px; height: 3px; top: 0; left: 0; }
        .corner.tl::after { width: 3px; height: 15px; top: 0; left: 0; }
        .corner.tr { top: -2px; right: -2px; }
        .corner.tr::before { width: 15px; height: 3px; top: 0; right: 0; }
        .corner.tr::after { width: 3px; height: 15px; top: 0; right: 0; }
        .corner.bl { bottom: -2px; left: -2px; }
        .corner.bl::before { width: 15px; height: 3px; bottom: 0; left: 0; }
        .corner.bl::after { width: 3px; height: 15px; bottom: 0; left: 0; }
        .corner.br { bottom: -2px; right: -2px; }
        .corner.br::before { width: 15px; height: 3px; bottom: 0; right: 0; }
        .corner.br::after { width: 3px; height: 15px; bottom: 0; right: 0; }
        
        .overlay-text { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(103, 78, 255, 0.9); color: white; padding: 8px 12px; 
            border-radius: 8px; font-size: 11px; text-align: center; font-weight: 600;
            white-space: nowrap;
        }
        
        .controls { 
            display: flex; gap: 10px; flex-direction: column; margin: 20px 0; 
        }
        
        .btn {
            padding: 16px; border: none; border-radius: 12px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s ease; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 56px; /* Touch-friendly */
        }
        .btn-primary { 
            background: linear-gradient(45deg, #674eff, #f093fb); color: white; 
            box-shadow: 0 4px 15px rgba(103, 78, 255, 0.3);
        }
        .btn-secondary { 
            background: #f8f9fa; color: #495057; border: 2px solid #dee2e6; 
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .manual-input { 
            background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0;
        }
        .manual-input input {
            width: 100%; padding: 16px; border: 2px solid #dee2e6; border-radius: 8px;
            font-size: 18px; margin-bottom: 15px; text-align: center; letter-spacing: 1px;
        }
        .manual-input input:focus { 
            outline: none; border-color: #674eff; 
            box-shadow: 0 0 0 3px rgba(103, 78, 255, 0.1); 
        }
        
        .status { 
            text-align: center; padding: 15px; border-radius: 10px; margin: 15px 0; 
            font-weight: 500; font-size: 14px;
        }
        .status.processing { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .result { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            border: 2px solid #674eff; border-radius: 15px; 
            padding: 25px; text-align: center; margin: 20px 0;
            box-shadow: 0 8px 25px rgba(103, 78, 255, 0.2);
        }
        .result-title { 
            color: #674eff; font-size: 18px; font-weight: 600; margin-bottom: 15px;
        }
        .detected-code { 
            background: #fff; padding: 20px; border-radius: 10px; 
            font-family: 'Courier New', monospace; font-size: 20px; font-weight: bold;
            letter-spacing: 2px; margin-bottom: 20px; border: 2px solid #674eff;
            color: #333; word-break: break-all;
        }
        
        .footer { 
            text-align: center; margin-top: 30px; padding: 20px; color: #666; 
            border-top: 1px solid #e9ecef; font-size: 14px;
        }
        .footer a { color: #674eff; text-decoration: none; font-weight: 600; }
        
        /* Animations */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .pulse { animation: pulse 1.5s infinite; }
        
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-2px); } 75% { transform: translateX(2px); } }
        .shake { animation: shake 0.5s ease-in-out; }
        
        /* Responsive */
        @media (max-width: 480px) {
            .app { padding: 10px; }
            .header { margin-bottom: 15px; padding: 15px; }
            .detected-code { font-size: 18px; padding: 15px; }
        }
        
        /* iOS Safari fixes */
        @media screen and (-webkit-min-device-pixel-ratio: 2) {
            video { -webkit-transform: translateZ(0); transform: translateZ(0); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="app">
            <div class="header">
                <h1>📱 Scanner Recharge</h1>
                <p>Scannez et rechargez automatiquement</p>
            </div>

            <!-- Carte Evatis -->
            <div class="card">
                <img src="evatis.jpg" alt="Carte Evatis" 
                     onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 250\'><rect width=\'400\' height=\'250\' fill=\'%23DAA520\'/><text x=\'200\' y=\'120\' text-anchor=\'middle\' fill=\'white\' font-size=\'20\' font-weight=\'bold\'>CARTE EVATIS</text><text x=\'200\' y=\'150\' text-anchor=\'middle\' fill=\'white\' font-size=\'32\' font-weight=\'bold\'>2000 FDJ</text></svg>'">
            </div>

            <!-- Caméra -->
            <div v-if="cameraActive || capturedImage" class="camera-container">
                <video ref="video" v-show="cameraActive && !capturedImage" 
                       autoplay playsinline webkit-playsinline muted
                       @loadedmetadata="onVideoReady"></video>
                <canvas ref="canvas" v-show="capturedImage" @click="retakePhoto"></canvas>
                
                <!-- Overlay avec crochets -->
                <div v-if="cameraActive && !capturedImage" class="overlay">
                    <div class="target-frame">
                        <div class="corner tl"></div>
                        <div class="corner tr"></div>
                        <div class="corner bl"></div>
                        <div class="corner br"></div>
                        <div class="overlay-text">
                            Alignez les 12 chiffres
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contrôles -->
            <div class="controls">
                <button v-if="!cameraActive" @click="startCamera" class="btn btn-primary">
                    📷 Ouvrir Scanner
                </button>
                
                <button v-if="cameraActive && !capturedImage && videoReady" @click="capturePhoto" class="btn btn-primary">
                    📸 Capturer Photo
                </button>
                
                <button v-if="capturedImage && !processing" @click="processImage" class="btn btn-primary">
                    🔍 Analyser Code
                </button>
                
                <button v-if="processing" disabled class="btn btn-primary pulse">
                    ⏳ {{ processingText }}
                </button>
                
                <button v-if="capturedImage" @click="retakePhoto" class="btn btn-secondary">
                    🔄 Recommencer
                </button>
                
                <button @click="toggleManual" class="btn btn-secondary">
                    ✏️ Saisie Manuelle
                </button>
            </div>

            <!-- Saisie manuelle -->
            <div v-if="showManual" class="manual-input">
                <input v-model="manualCode" 
                       placeholder="12 chiffres de la carte"
                       maxlength="12"
                       @input="validateManual"
                       type="tel"
                       inputmode="numeric">
                <button @click="useManual" :disabled="manualCode.length !== 12" class="btn btn-primary">
                    ✅ Utiliser Code
                </button>
            </div>

            <!-- Statut -->
            <div v-if="status" :class="`status ${status.type}`">
                {{ status.message }}
            </div>

            <!-- Résultat -->
            <div v-if="detectedCode" class="result">
                <div class="result-title">✅ Code Détecté</div>
                <div class="detected-code">[{{ detectedCode }}]</div>
                <div class="controls">
                    <button @click="makeCall" class="btn btn-primary">
                        📞 Appeler *166*
                    </button>
                    <button @click="copyCode" class="btn btn-secondary">
                        📋 Copier
                    </button>
                </div>
            </div>

            <div class="footer">
                <p>Création d'<a href="https://opentek.co/" target="_blank">Opentek</a></p>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // État
                const video = ref(null);
                const canvas = ref(null);
                const cameraActive = ref(false);
                const capturedImage = ref(false);
                const processing = ref(false);
                const processingText = ref('Analyse...');
                const detectedCode = ref('');
                const status = ref(null);
                const showManual = ref(false);
                const manualCode = ref('');
                const videoReady = ref(false);
                let stream = null;

                // PWA
                onMounted(() => {
                    if ('serviceWorker' in navigator) {
                        const swCode = `
                            const CACHE = 'evatis-v4';
                            const FILES = ['./', 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js'];
                            self.addEventListener('install', e => { e.waitUntil(caches.open(CACHE).then(c => c.addAll(FILES))); self.skipWaiting(); });
                            self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
                            self.addEventListener('activate', e => { e.waitUntil(clients.claim()); });
                        `;
                        const blob = new Blob([swCode], {type: 'application/javascript'});
                        navigator.serviceWorker.register(URL.createObjectURL(blob))
                            .then(() => console.log('✅ PWA ready'))
                            .catch(e => console.log('❌ PWA error:', e));
                    }
                });

                // Utilitaires
                const setStatus = (message, type = 'processing', duration = 3000) => {
                    status.value = { message, type };
                    if (duration > 0) {
                        setTimeout(() => status.value = null, duration);
                    }
                };

                const vibrate = (pattern) => {
                    if (navigator.vibrate) navigator.vibrate(pattern);
                };

                // Détection plateforme
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                const isAndroid = /Android/.test(navigator.userAgent);
                const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);

                console.log('📱 Plateforme:', { isIOS, isAndroid, isSafari, userAgent: navigator.userAgent });

                // Caméra avec compatibility maximale
                const startCamera = async () => {
                    try {
                        setStatus('Demande d\'autorisation caméra...', 'processing', 0);
                        
                        // Contraintes progressives (du plus spécifique au plus général)
                        const constraintsList = [
                            // Essai 1: Optimal pour mobile
                            {
                                video: {
                                    facingMode: { exact: 'environment' },
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            },
                            // Essai 2: Moins strict
                            {
                                video: {
                                    facingMode: 'environment',
                                    width: { ideal: 1280 },
                                    height: { ideal: 720 }
                                }
                            },
                            // Essai 3: Basique
                            {
                                video: {
                                    facingMode: 'environment'
                                }
                            },
                            // Essai 4: Dernière chance
                            {
                                video: true
                            }
                        ];

                        let success = false;
                        
                        for (let i = 0; i < constraintsList.length && !success; i++) {
                            try {
                                console.log(`🔍 Essai ${i + 1}:`, constraintsList[i]);
                                stream = await navigator.mediaDevices.getUserMedia(constraintsList[i]);
                                success = true;
                                console.log('✅ Caméra obtenue avec contraintes', i + 1);
                            } catch (err) {
                                console.log(`❌ Essai ${i + 1} échoué:`, err.name, err.message);
                                if (i === constraintsList.length - 1) {
                                    throw err; // Dernière tentative, on lance l'erreur
                                }
                            }
                        }

                        if (!stream) {
                            throw new Error('Impossible d\'obtenir l\'accès caméra');
                        }

                        // Configuration vidéo optimisée pour mobile
                        const videoEl = video.value;
                        videoEl.srcObject = stream;
                        
                        // Attributs critiques pour mobile
                        videoEl.setAttribute('playsinline', 'true');
                        videoEl.setAttribute('webkit-playsinline', 'true');
                        videoEl.muted = true;
                        videoEl.autoplay = true;
                        
                        // Forcer le démarrage
                        try {
                            await videoEl.play();
                        } catch (playError) {
                            console.log('⚠️ Erreur play:', playError);
                            // Essayer avec interaction utilisateur
                            videoEl.onclick = () => videoEl.play();
                        }

                        cameraActive.value = true;
                        setStatus('✅ Caméra active - Alignez votre carte', 'success');
                        vibrate(50);

                    } catch (error) {
                        console.error('❌ Erreur caméra complète:', error);
                        
                        const errorMessages = {
                            'NotAllowedError': '❌ Veuillez autoriser l\'accès à la caméra',
                            'NotFoundError': '❌ Aucune caméra trouvée sur cet appareil',
                            'NotSupportedError': '❌ Caméra non supportée',
                            'OverconstrainedError': '❌ Contraintes caméra non supportées',
                            'NotReadableError': '❌ Caméra utilisée par une autre app'
                        };

                        const message = errorMessages[error.name] || `❌ Erreur caméra: ${error.message}`;
                        setStatus(message, 'error', 0);
                        
                        // Afficher aide selon plateforme
                        setTimeout(() => {
                            if (isIOS) {
                                setStatus('💡 iPhone: Ouvrez dans Safari, autorisez caméra', 'error', 0);
                            } else if (isAndroid) {
                                setStatus('💡 Android: Ouvrez dans Chrome, autorisez caméra', 'error', 0);
                            }
                        }, 2000);
                    }
                };

                const onVideoReady = () => {
                    console.log('📹 Vidéo prête:', video.value.videoWidth, 'x', video.value.videoHeight);
                    videoReady.value = true;
                };

                const capturePhoto = () => {
                    if (!videoReady.value) return;
                    
                    const ctx = canvas.value.getContext('2d');
                    const videoEl = video.value;
                    
                    canvas.value.width = videoEl.videoWidth || 1280;
                    canvas.value.height = videoEl.videoHeight || 720;
                    
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(videoEl, 0, 0);
                    
                    capturedImage.value = true;
                    videoReady.value = false;
                    
                    // Arrêter caméra pour économiser batterie
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    
                    setStatus('📸 Photo prise avec succès', 'success');
                    vibrate([50, 30, 50]);
                };

                const retakePhoto = () => {
                    capturedImage.value = false;
                    processing.value = false;
                    detectedCode.value = '';
                    videoReady.value = false;
                    startCamera();
                };

                const processImage = async () => {
                    processing.value = true;
                    processingText.value = 'Initialisation...';
                    setStatus('🔍 Analyse de l\'image...', 'processing', 0);

                    try {
                        const { data: { text, confidence } } = await Tesseract.recognize(
                            canvas.value,
                            'eng',
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text' && m.progress) {
                                        const progress = Math.round(m.progress * 100);
                                        processingText.value = `${progress}%`;
                                        setStatus(`🔍 Reconnaissance: ${progress}%`, 'processing', 0);
                                    }
                                },
                                tessedit_char_whitelist: '0123456789',
                                tesseract_pageseg_mode: '8'
                            }
                        );

                        const numbers = text.replace(/\D/g, '');
                        console.log('📝 Texte OCR:', text);
                        console.log('🔢 Chiffres:', numbers);
                        console.log('🎯 Confiance:', confidence);
                        
                        if (numbers.length >= 12) {
                            const code = numbers.substring(0, 12);
                            detectedCode.value = code;
                            processing.value = false;
                            
                            setStatus(`✅ Code détecté! (${Math.round(confidence)}% confiance)`, 'success');
                            vibrate([100, 50, 100, 50, 100]);
                            
                        } else if (numbers.length > 0) {
                            processing.value = false;
                            setStatus(`⚠️ Seulement ${numbers.length} chiffres trouvés (12 requis)`, 'error');
                        } else {
                            processing.value = false;
                            setStatus('❌ Aucun chiffre détecté. Essayez de nouveau', 'error');
                        }
                        
                    } catch (error) {
                        processing.value = false;
                        console.error('❌ Erreur OCR:', error);
                        setStatus('❌ Erreur d\'analyse. Essayez la saisie manuelle', 'error');
                    }
                };

                // Manuel
                const toggleManual = () => {
                    showManual.value = !showManual.value;
                    if (showManual.value) {
                        manualCode.value = '';
                    }
                };

                const validateManual = () => {
                    manualCode.value = manualCode.value.replace(/\D/g, '').substring(0, 12);
                };

                const useManual = () => {
                    detectedCode.value = manualCode.value;
                    showManual.value = false;
                    setStatus('✅ Code saisi manuellement', 'success');
                };

                // Actions
                const makeCall = () => {
                    const phoneNumber = `*166*${detectedCode.value}#`;
                    console.log('📞 Appel:', phoneNumber);
                    
                    try {
                        window.location.href = `tel:${phoneNumber}`;
                        setStatus('📞 Ouverture téléphone...', 'success');
                        vibrate(200);
                    } catch (error) {
                        setStatus('❌ Impossible d\'ouvrir le téléphone', 'error');
                    }
                };

                const copyCode = async () => {
                    const text = `[${detectedCode.value}]`;
                    
                    try {
                        if (navigator.clipboard && window.isSecureContext) {
                            await navigator.clipboard.writeText(text);
                        } else {
                            // Fallback
                            const textArea = document.createElement('textarea');
                            textArea.value = text;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-9999px';
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            textArea.remove();
                        }
                        
                        setStatus('📋 Code copié!', 'success');
                        vibrate(50);
                        
                    } catch (error) {
                        setStatus('❌ Erreur de copie', 'error');
                    }
                };

                return {
                    video, canvas, cameraActive, capturedImage, processing, processingText,
                    detectedCode, status, showManual, manualCode, videoReady,
                    startCamera, onVideoReady, capturePhoto, retakePhoto, processImage,
                    toggleManual, validateManual, useManual, makeCall, copyCode
                };
            }
        }).mount('#app');
    </script>
</body>
</html>