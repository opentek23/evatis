<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Recharge Evatis</title>
    
    <!-- PWA -->
    <meta name="theme-color" content="#674eff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2Nhbm5lciBSZWNoYXJnZSBFdmF0aXMiLCJzaG9ydF9uYW1lIjoiU2Nhbm5lciIsInN0YXJ0X3VybCI6Ii4vIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJ0aGVtZV9jb2xvciI6IiM2NzRlZmYiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgdmlld0JveD0nMCAwIDE5MiAxOTInJTNFJTNDcmVjdCB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5MicgZmlsbD0nJTIzNjc0ZWZmJyByeD0nMjQnLyUzRSUzQ3RleHQgeD0nOTYnIHk9JzEzMCcgZm9udC1zaXplPScxMDAnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZpbGw9J3doaXRlJyUzRSUyMyUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ==">
    
    <!-- Vue.js 3 et Tesseract.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff; color: #333; min-height: 100vh; line-height: 1.6;
        }
        
        .container { max-width: 450px; margin: 0 auto; padding: 15px; }
        
        .header { 
            text-align: center; margin-bottom: 25px; padding: 20px; 
            background: linear-gradient(135deg, rgba(103, 78, 255, 0.1), rgba(240, 147, 251, 0.1));
            border-radius: 15px; border: 1px solid rgba(103, 78, 255, 0.2);
        }
        .header h1 { 
            background: linear-gradient(45deg, #674eff, #f093fb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-size: 24px; margin-bottom: 8px;
        }
        .header p { color: #666; font-size: 14px; }
        
        .evatis-card { 
            background: #fff; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            margin-bottom: 25px; overflow: hidden; transform: perspective(1000px) rotateX(2deg);
            transition: transform 0.3s ease;
        }
        .evatis-card:hover { transform: perspective(1000px) rotateX(0deg) scale(1.02); }
        .evatis-card img { width: 100%; height: auto; display: block; }
        
        .camera-container { 
            background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 15px; 
            aspect-ratio: 4/3; position: relative; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        video, canvas { width: 100%; height: 100%; object-fit: cover; border-radius: 13px; }
        
        .detection-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.3); z-index: 10;
        }
        
        .detection-brackets {
            position: relative; width: 80%; height: 40%;
            border: 2px solid #674eff; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
        }
        
        .bracket {
            position: absolute; width: 30px; height: 30px; border: 3px solid #674eff;
        }
        .bracket.top-left { top: -3px; left: -3px; border-right: none; border-bottom: none; }
        .bracket.top-right { top: -3px; right: -3px; border-left: none; border-bottom: none; }
        .bracket.bottom-left { bottom: -3px; left: -3px; border-right: none; border-top: none; }
        .bracket.bottom-right { bottom: -3px; right: -3px; border-left: none; border-top: none; }
        
        .overlay-text { 
            background: rgba(103, 78, 255, 0.9); color: white; padding: 8px 16px; 
            border-radius: 8px; font-size: 12px; text-align: center; font-weight: 600;
        }
        
        .controls { 
            display: flex; gap: 12px; flex-wrap: wrap; justify-content: center; margin: 20px 0; 
        }
        
        .btn {
            padding: 14px 20px; border: none; border-radius: 10px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s ease; min-width: 130px; font-size: 15px;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .btn-primary { 
            background: linear-gradient(45deg, #674eff, #f093fb); color: white; 
            box-shadow: 0 4px 15px rgba(103, 78, 255, 0.3);
        }
        .btn-secondary { 
            background: #f8f9fa; color: #495057; border: 2px solid #dee2e6; 
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(103, 78, 255, 0.4); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        .manual-input { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; 
            border-radius: 15px; margin: 20px 0; border: 1px solid #dee2e6;
        }
        .manual-input input {
            width: 100%; padding: 14px; border: 2px solid #dee2e6; border-radius: 8px;
            font-size: 16px; margin-bottom: 12px; transition: border-color 0.3s;
        }
        .manual-input input:focus { 
            outline: none; border-color: #674eff; 
            box-shadow: 0 0 0 3px rgba(103, 78, 255, 0.1); 
        }
        
        .status { 
            text-align: center; padding: 12px 16px; border-radius: 8px; margin: 15px 0; 
            font-weight: 500; animation: fadeIn 0.3s ease;
        }
        .status.processing { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        .result { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            border: 2px solid #674eff; border-radius: 15px; 
            padding: 25px; text-align: center; margin: 20px 0;
            box-shadow: 0 8px 25px rgba(103, 78, 255, 0.2);
        }
        .result-title { 
            color: #674eff; font-size: 18px; font-weight: 600; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .detected-code { 
            background: #fff; padding: 16px; border-radius: 8px; 
            font-family: 'Monaco', 'Courier New', monospace; font-size: 20px; 
            letter-spacing: 1px; margin-bottom: 20px; border: 2px solid #674eff;
            color: #333; font-weight: bold; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .footer { 
            text-align: center; margin-top: 40px; padding: 20px; color: #666; 
            border-top: 1px solid #e9ecef;
        }
        .footer a { 
            color: #674eff; text-decoration: none; font-weight: 600; 
            transition: color 0.3s ease;
        }
        .footer a:hover { color: #f093fb; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .pulse { animation: pulse 1.5s infinite; }
        
        @media (max-width: 480px) {
            .container { padding: 12px; }
            .controls { flex-direction: column; gap: 8px; }
            .btn { min-width: 100%; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <div class="header">
                <h1>📱 Scanner Recharge</h1>
                <p>Scannez et rechargez votre carte Evatis automatiquement</p>
            </div>

            <!-- Carte Evatis -->
            <div class="evatis-card">
                <img src="evatis.jpg" alt="Carte Prépayée Evatis 2000 FDJ" 
                     onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 250\'><rect width=\'400\' height=\'250\' fill=\'%23DAA520\'/><text x=\'200\' y=\'130\' text-anchor=\'middle\' fill=\'white\' font-size=\'24\' font-weight=\'bold\'>CARTE EVATIS 2000 FDJ</text></svg>'">
            </div>

            <!-- Caméra avec overlay intelligent -->
            <div v-if="cameraActive || capturedImage" class="camera-container">
                <video ref="video" v-show="cameraActive && !capturedImage" 
                       autoplay playsinline webkit-playsinline muted></video>
                <canvas ref="canvas" v-show="capturedImage" @click="retakePhoto"></canvas>
                
                <!-- Overlay avec crochets qui n'apparaît que quand nécessaire -->
                <div v-if="cameraActive && !capturedImage && !processing" class="detection-overlay">
                    <div class="detection-brackets">
                        <div class="bracket top-left"></div>
                        <div class="bracket top-right"></div>
                        <div class="bracket bottom-left"></div>
                        <div class="bracket bottom-right"></div>
                        <div class="overlay-text">
                            📷 Alignez les 12 chiffres ici<br>
                            <small>Maintenez stable et bien éclairé</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contrôles -->
            <div class="controls">
                <button v-if="!cameraActive" @click="startCamera" class="btn btn-primary">
                    📷 Démarrer Scanner
                </button>
                
                <button v-if="cameraActive && !capturedImage" @click="capturePhoto" class="btn btn-primary">
                    📸 Capturer
                </button>
                
                <button v-if="capturedImage && !processing" @click="processImage" class="btn btn-primary">
                    🔍 Analyser Code
                </button>
                
                <button v-if="processing" disabled class="btn btn-primary pulse">
                    ⏳ {{ processingText }}
                </button>
                
                <button v-if="capturedImage" @click="retakePhoto" class="btn btn-secondary">
                    🔄 Reprendre
                </button>
                
                <button @click="toggleManualInput" class="btn btn-secondary">
                    ✏️ Saisie Manuelle
                </button>
            </div>

            <!-- Saisie manuelle -->
            <div v-if="showManualInput" class="manual-input">
                <input v-model="manualCode" 
                       placeholder="Entrez le code à 12 chiffres"
                       maxlength="12"
                       @input="validateManualInput"
                       type="tel">
                <button @click="useManualCode" :disabled="manualCode.length !== 12" class="btn btn-primary">
                    ✅ Utiliser ce Code
                </button>
            </div>

            <!-- Statut -->
            <div v-if="status" :class="`status ${status.type}`">
                {{ status.message }}
            </div>

            <!-- Résultat avec appel automatique -->
            <div v-if="detectedCode" class="result">
                <div class="result-title">✅ Code Détecté !</div>
                <div class="detected-code">[{{ detectedCode }}]</div>
                <div class="controls">
                    <button @click="makeAutoCall" class="btn btn-primary">
                        📞 Appeler Maintenant
                    </button>
                    <button @click="copyCode" class="btn btn-secondary">
                        📋 Copier Code
                    </button>
                </div>
            </div>

            <div class="footer">
                <p>Création d'<a href="https://opentek.co/" target="_blank">Opentek</a></p>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                // État réactif
                const video = ref(null);
                const canvas = ref(null);
                const cameraActive = ref(false);
                const capturedImage = ref(false);
                const processing = ref(false);
                const processingText = ref('Analyse...');
                const detectedCode = ref('');
                const status = ref(null);
                const showManualInput = ref(false);
                const manualCode = ref('');
                let stream = null;

                // PWA Service Worker
                onMounted(() => {
                    if ('serviceWorker' in navigator) {
                        const swCode = `
                            const CACHE_NAME = 'evatis-v3';
                            const FILES = ['./', 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js', 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js'];
                            self.addEventListener('install', e => e.waitUntil(caches.open(CACHE_NAME).then(c => c.addAll(FILES))));
                            self.addEventListener('fetch', e => e.respondWith(caches.match(e.request).then(r => r || fetch(e.request))));
                        `;
                        const blob = new Blob([swCode], {type: 'application/javascript'});
                        navigator.serviceWorker.register(URL.createObjectURL(blob));
                    }
                });

                // Utilitaires
                const setStatus = (message, type = 'processing', duration = 3000) => {
                    status.value = { message, type };
                    setTimeout(() => status.value = null, duration);
                };

                const vibrate = (pattern) => {
                    if (navigator.vibrate) navigator.vibrate(pattern);
                };

                // Gestion caméra
                const startCamera = async () => {
                    try {
                        setStatus('Initialisation caméra...', 'processing');
                        
                        const constraints = {
                            video: { 
                                facingMode: { ideal: 'environment' },
                                width: { ideal: 1920, min: 640 },
                                height: { ideal: 1080, min: 480 }
                            }
                        };

                        try {
                            stream = await navigator.mediaDevices.getUserMedia(constraints);
                        } catch (err) {
                            stream = await navigator.mediaDevices.getUserMedia({
                                video: { facingMode: 'environment' }
                            });
                        }

                        video.value.srcObject = stream;
                        await video.value.play();
                        
                        cameraActive.value = true;
                        setStatus('✅ Caméra prête - Alignez votre carte', 'success');
                        vibrate(50);
                        
                    } catch (error) {
                        const errorMessages = {
                            'NotAllowedError': 'Veuillez autoriser l\'accès à la caméra',
                            'NotFoundError': 'Aucune caméra trouvée',
                            'NotSupportedError': 'Caméra non supportée'
                        };
                        setStatus(errorMessages[error.name] || 'Erreur caméra', 'error', 5000);
                    }
                };

                const capturePhoto = () => {
                    const ctx = canvas.value.getContext('2d');
                    canvas.value.width = video.value.videoWidth;
                    canvas.value.height = video.value.videoHeight;
                    
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    ctx.drawImage(video.value, 0, 0);
                    
                    capturedImage.value = true;
                    
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        stream = null;
                    }
                    
                    setStatus('📸 Photo capturée', 'success');
                    vibrate([50, 30, 50]);
                };

                const retakePhoto = () => {
                    capturedImage.value = false;
                    processing.value = false;
                    detectedCode.value = '';
                    startCamera();
                };

                const processImage = async () => {
                    processing.value = true;
                    processingText.value = 'Initialisation...';
                    setStatus('🔍 Analyse de l\'image...', 'processing');

                    try {
                        const { data: { text, confidence } } = await Tesseract.recognize(
                            canvas.value,
                            'eng',
                            {
                                logger: m => {
                                    if (m.status === 'recognizing text') {
                                        const progress = Math.round(m.progress * 100);
                                        processingText.value = `Analyse ${progress}%`;
                                        setStatus(`🔍 Reconnaissance: ${progress}%`, 'processing');
                                    }
                                },
                                tessedit_char_whitelist: '0123456789',
                                tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK
                            }
                        );

                        console.log('OCR Résultat:', text, 'Confiance:', confidence);
                        
                        // Extraction des chiffres
                        const numbers = text.replace(/\D/g, '');
                        console.log('Chiffres extraits:', numbers);
                        
                        if (numbers.length >= 12) {
                            const code = numbers.substring(0, 12);
                            detectedCode.value = code;
                            processing.value = false;
                            
                            setStatus('✅ Code détecté avec succès!', 'success', 4000);
                            vibrate([100, 50, 100, 50, 100]);
                            
                            // Auto-appel après 2 secondes si souhaité
                            setTimeout(() => {
                                if (detectedCode.value && confirm(`Code détecté: ${code}\n\nAppeler automatiquement *166*${code}# ?`)) {
                                    makeAutoCall();
                                }
                            }, 2000);
                            
                        } else if (numbers.length > 0) {
                            processing.value = false;
                            setStatus(`⚠️ ${numbers.length} chiffres trouvés (12 requis)`, 'error', 5000);
                        } else {
                            processing.value = false;
                            setStatus('❌ Aucun chiffre détecté', 'error', 5000);
                        }
                        
                    } catch (error) {
                        processing.value = false;
                        console.error('Erreur OCR:', error);
                        setStatus('❌ Erreur d\'analyse', 'error', 5000);
                    }
                };

                // Gestion manuelle
                const toggleManualInput = () => {
                    showManualInput.value = !showManualInput.value;
                    if (showManualInput.value) {
                        manualCode.value = '';
                        setTimeout(() => {
                            const input = document.querySelector('#app input[type="tel"]');
                            if (input) input.focus();
                        }, 100);
                    }
                };

                const validateManualInput = () => {
                    manualCode.value = manualCode.value.replace(/\D/g, '').substring(0, 12);
                };

                const useManualCode = () => {
                    detectedCode.value = manualCode.value;
                    showManualInput.value = false;
                    setStatus('✅ Code saisi', 'success');
                };

                // Actions sur le code
                const makeAutoCall = () => {
                    const phoneNumber = `*166*${detectedCode.value}#`;
                    console.log('Appel:', phoneNumber);
                    
                    try {
                        window.location.href = `tel:${phoneNumber}`;
                        setStatus('📞 Appel en cours...', 'success', 4000);
                        vibrate(200);
                    } catch (error) {
                        setStatus('❌ Impossible d\'appeler', 'error');
                    }
                };

                const copyCode = async () => {
                    const textToCopy = `[${detectedCode.value}]`;
                    
                    try {
                        if (navigator.clipboard) {
                            await navigator.clipboard.writeText(textToCopy);
                        } else {
                            // Fallback
                            const textArea = document.createElement('textarea');
                            textArea.value = textToCopy;
                            textArea.style.position = 'fixed';
                            textArea.style.left = '-999999px';
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            textArea.remove();
                        }
                        
                        setStatus('📋 Code copié!', 'success');
                        vibrate(50);
                        
                    } catch (error) {
                        setStatus('❌ Erreur copie', 'error');
                    }
                };

                return {
                    video, canvas, cameraActive, capturedImage, processing, processingText,
                    detectedCode, status, showManualInput, manualCode,
                    startCamera, capturePhoto, retakePhoto, processImage,
                    toggleManualInput, validateManualInput, useManualCode,
                    makeAutoCall, copyCode
                };
            }
        }).mount('#app');
    </script>
</body>
</html>