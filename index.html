<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner Recharge Evatis - IA</title>
    
    <!-- PWA Meta -->
    <meta name="theme-color" content="#674eff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scanner Evatis">
    
    <!-- Tesseract.js CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff; color: #333; min-height: 100vh; 
            -webkit-text-size-adjust: 100%; -webkit-font-smoothing: antialiased;
        }
        
        .app { max-width: 450px; margin: 0 auto; padding: 15px; min-height: 100vh; }
        
        .header { 
            text-align: center; margin-bottom: 20px; padding: 20px; 
            background: linear-gradient(135deg, rgba(103, 78, 255, 0.1), rgba(240, 147, 251, 0.1));
            border-radius: 15px; border: 1px solid rgba(103, 78, 255, 0.2);
        }
        .header h1 { 
            background: linear-gradient(45deg, #674eff, #f093fb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text; font-size: 24px; margin-bottom: 8px; font-weight: 700;
        }
        .header p { color: #666; font-size: 14px; }
        
        .ai-badge {
            display: inline-block; background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px;
            font-weight: bold; margin-left: 8px; animation: pulse 2s infinite;
        }
        
        .card { 
            background: #fff; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            margin-bottom: 20px; overflow: hidden; 
        }
        .card img { width: 100%; height: auto; display: block; }
        
        .camera-section { margin: 20px 0; }
        .camera-container { 
            background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 15px; 
            aspect-ratio: 4/3; position: relative; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); overflow: hidden;
            display: none;
        }
        .camera-container.active { display: block; }
        
        video, canvas { 
            width: 100%; height: 100%; object-fit: cover; border-radius: 13px;
            background: #000;
        }
        
        /* Overlay amélioré avec détection temps réel */
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 45%; border: 3px solid #674eff; border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(103, 78, 255, 0.1); backdrop-filter: blur(3px);
            transition: all 0.3s ease;
        }
        
        .overlay.detecting {
            border-color: #ff6b6b; box-shadow: 0 0 20px rgba(255, 107, 107, 0.5);
            animation: detectPulse 1s infinite;
        }
        
        .overlay.found {
            border-color: #2ecc71; box-shadow: 0 0 20px rgba(46, 204, 113, 0.5);
            background: rgba(46, 204, 113, 0.2);
        }
        
        /* Crochets intelligents */
        .overlay::before, .overlay::after,
        .corner-bl, .corner-br {
            content: ''; position: absolute; width: 35px; height: 35px;
            border: 4px solid #674eff; transition: all 0.3s ease;
        }
        .overlay::before { top: -4px; left: -4px; border-right: none; border-bottom: none; }
        .overlay::after { top: -4px; right: -4px; border-left: none; border-bottom: none; }
        .corner-bl { bottom: -4px; left: -4px; border-right: none; border-top: none; }
        .corner-br { bottom: -4px; right: -4px; border-left: none; border-top: none; }
        
        .overlay.detecting::before, .overlay.detecting::after,
        .overlay.detecting .corner-bl, .overlay.detecting .corner-br {
            border-color: #ff6b6b;
        }
        
        .overlay.found::before, .overlay.found::after,
        .overlay.found .corner-bl, .overlay.found .corner-br {
            border-color: #2ecc71;
        }
        
        .overlay-text { 
            background: rgba(103, 78, 255, 0.9); color: white; padding: 10px 15px; 
            border-radius: 10px; font-size: 13px; text-align: center; font-weight: 600;
            z-index: 5; position: relative; transition: all 0.3s ease;
        }
        
        .overlay.detecting .overlay-text {
            background: rgba(255, 107, 107, 0.9);
        }
        
        .overlay.found .overlay-text {
            background: rgba(46, 204, 113, 0.9);
        }
        
        .controls { 
            display: flex; gap: 10px; flex-direction: column; margin: 20px 0; 
        }
        
        .btn {
            padding: 16px; border: none; border-radius: 12px; font-weight: 600; 
            cursor: pointer; transition: all 0.3s ease; font-size: 16px;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            min-height: 56px;
        }
        .btn-primary { 
            background: linear-gradient(45deg, #674eff, #f093fb); color: white; 
            box-shadow: 0 4px 15px rgba(103, 78, 255, 0.3);
        }
        .btn-secondary { 
            background: #f8f9fa; color: #495057; border: 2px solid #dee2e6; 
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .btn.hidden { display: none; }
        
        .auto-scan-toggle {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            margin-bottom: 10px;
        }
        
        .manual-input { 
            background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 20px 0;
            display: none;
        }
        .manual-input.active { display: block; }
        .manual-input input {
            width: 100%; padding: 16px; border: 2px solid #dee2e6; border-radius: 8px;
            font-size: 18px; margin-bottom: 15px; text-align: center; letter-spacing: 1px;
        }
        .manual-input input:focus { 
            outline: none; border-color: #674eff; 
            box-shadow: 0 0 0 3px rgba(103, 78, 255, 0.1); 
        }
        
        .status { 
            text-align: center; padding: 15px; border-radius: 10px; margin: 15px 0; 
            font-weight: 500; font-size: 14px; display: none;
        }
        .status.active { display: block; }
        .status.processing { background: #fff3cd; color: #856404; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.detecting { background: #ffe6e6; color: #d73027; }
        
        .result { 
            background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
            border: 2px solid #674eff; border-radius: 15px; 
            padding: 25px; text-align: center; margin: 20px 0;
            box-shadow: 0 8px 25px rgba(103, 78, 255, 0.2);
            display: none;
        }
        .result.active { display: block; animation: slideUp 0.4s ease; }
        .result-title { 
            color: #674eff; font-size: 18px; font-weight: 600; margin-bottom: 15px;
        }
        .detected-code { 
            background: #fff; padding: 20px; border-radius: 10px; 
            font-family: 'Courier New', monospace; font-size: 20px; font-weight: bold;
            letter-spacing: 2px; margin-bottom: 20px; border: 2px solid #674eff;
            color: #333; word-break: break-all;
        }
        
        .confidence-bar {
            background: #e9ecef; height: 8px; border-radius: 4px; margin: 10px 0;
            overflow: hidden;
        }
        .confidence-fill {
            background: linear-gradient(45deg, #2ecc71, #27ae60);
            height: 100%; transition: width 0.3s ease; border-radius: 4px;
        }
        
        .footer { 
            text-align: center; margin-top: 30px; padding: 20px; color: #666; 
            border-top: 1px solid #e9ecef; font-size: 14px;
        }
        .footer a { color: #674eff; text-decoration: none; font-weight: 600; }
        
        /* Animations */
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes detectPulse { 
            0%, 100% { box-shadow: 0 0 10px rgba(255, 107, 107, 0.3); }
            50% { box-shadow: 0 0 30px rgba(255, 107, 107, 0.8); }
        }
        
        @keyframes slideUp { 
            from { transform: translateY(20px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        /* Auto-call notification */
        .auto-call-notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #674eff; color: white; padding: 15px 20px;
            border-radius: 10px; font-weight: 600; z-index: 1000;
            box-shadow: 0 4px 20px rgba(103, 78, 255, 0.4);
            display: none; animation: slideDown 0.3s ease;
        }
        .auto-call-notification.active { display: block; }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); }
            to { transform: translate(-50%, 0); }
        }
        
        /* Loading IA */
        .ai-loading {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: white; padding: 30px;
            border-radius: 15px; z-index: 2000; text-align: center;
            display: none;
        }
        .ai-loading.active { display: block; }
        
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid #674eff; border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Responsive */
        @media (max-width: 480px) {
            .app { padding: 10px; }
            .header { margin-bottom: 15px; padding: 15px; }
            .detected-code { font-size: 18px; padding: 15px; }
            .overlay-text { font-size: 11px; padding: 8px 12px; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>🚀 Scanner IA <span class="ai-badge">IA AVANCÉE</span></h1>
            <p>Détection automatique comme Google Lens</p>
        </div>

        <!-- Carte Evatis -->
        <div class="card">
            <img id="evatisImg" src="evatis.jpg" alt="Carte Evatis" 
                 onerror="this.src='data:image/svg+xml,<svg xmlns=\'http://www.w3.org/2000/svg\' viewBox=\'0 0 400 250\'><rect width=\'400\' height=\'250\' fill=\'%23DAA520\'/><text x=\'200\' y=\'120\' text-anchor=\'middle\' fill=\'white\' font-size=\'20\' font-weight=\'bold\'>CARTE EVATIS</text><text x=\'200\' y=\'150\' text-anchor=\'middle\' fill=\'white\' font-size=\'32\' font-weight=\'bold\'>2000 FDJ</text></svg>'">
        </div>

        <!-- Section Caméra -->
        <div class="camera-section">
            <div id="cameraContainer" class="camera-container">
                <video id="video" autoplay playsinline webkit-playsinline muted></video>
                <canvas id="canvas" style="display: none;"></canvas>
                
                <!-- Overlay intelligent -->
                <div id="overlay" class="overlay">
                    <div class="corner-bl"></div>
                    <div class="corner-br"></div>
                    <div id="overlayText" class="overlay-text">
                        🤖 IA prête - Positionnez les 12 chiffres
                    </div>
                </div>
            </div>

            <!-- Contrôles -->
            <div class="controls">
                <button id="autoScanBtn" class="btn auto-scan-toggle hidden">
                    🤖 Scan Automatique IA (ON)
                </button>
                
                <button id="startCameraBtn" class="btn btn-primary">
                    📷 Démarrer Scanner IA
                </button>
                
                <button id="stopScanBtn" class="btn btn-secondary hidden">
                    ⏹️ Arrêter Scan
                </button>
                
                <button id="manualBtn" class="btn btn-secondary">
                    ✏️ Saisie Manuelle
                </button>
            </div>
        </div>

        <!-- Saisie manuelle -->
        <div id="manualInput" class="manual-input">
            <input id="manualCode" 
                   placeholder="12 chiffres de la carte"
                   maxlength="12"
                   type="tel"
                   inputmode="numeric">
            <button id="useManualBtn" class="btn btn-primary" disabled>
                ✅ Utiliser Code
            </button>
        </div>

        <!-- Statut -->
        <div id="status" class="status"></div>

        <!-- Résultat -->
        <div id="result" class="result">
            <div class="result-title">🎯 Code Détecté par IA</div>
            <div id="detectedCode" class="detected-code"></div>
            <div class="confidence-bar">
                <div id="confidenceFill" class="confidence-fill" style="width: 0%"></div>
            </div>
            <p id="confidenceText" style="font-size: 12px; color: #666; margin: 5px 0;">Confiance: 0%</p>
            <div class="controls">
                <button id="callBtn" class="btn btn-primary">
                    📞 Appeler *166*
                </button>
                <button id="copyBtn" class="btn btn-secondary">
                    📋 Copier Code
                </button>
            </div>
        </div>

        <!-- Notification d'appel automatique -->
        <div id="autoCallNotification" class="auto-call-notification">
            🚀 Appel automatique dans <span id="countdown">3</span>s...
        </div>

        <!-- Loading IA -->
        <div id="aiLoading" class="ai-loading">
            <div class="spinner"></div>
            <div id="aiLoadingText">Chargement IA Tesseract...</div>
        </div>

        <div class="footer">
            <p>Création d'<a href="https://opentek.co/" target="_blank">Opentek</a> - Powered by Tesseract.js</p>
        </div>
    </div>

    <script>
        // Variables globales
        let stream = null;
        let cameraActive = false;
        let autoScanActive = true;
        let scanningInterval = null;
        let worker = null;
        let detectedCodeValue = '';
        let isProcessing = false;

        // Éléments DOM
        const elements = {
            video: document.getElementById('video'),
            canvas: document.getElementById('canvas'),
            cameraContainer: document.getElementById('cameraContainer'),
            overlay: document.getElementById('overlay'),
            overlayText: document.getElementById('overlayText'),
            startCameraBtn: document.getElementById('startCameraBtn'),
            autoScanBtn: document.getElementById('autoScanBtn'),
            stopScanBtn: document.getElementById('stopScanBtn'),
            manualBtn: document.getElementById('manualBtn'),
            manualInput: document.getElementById('manualInput'),
            manualCode: document.getElementById('manualCode'),
            useManualBtn: document.getElementById('useManualBtn'),
            status: document.getElementById('status'),
            result: document.getElementById('result'),
            detectedCode: document.getElementById('detectedCode'),
            confidenceFill: document.getElementById('confidenceFill'),
            confidenceText: document.getElementById('confidenceText'),
            callBtn: document.getElementById('callBtn'),
            copyBtn: document.getElementById('copyBtn'),
            autoCallNotification: document.getElementById('autoCallNotification'),
            countdown: document.getElementById('countdown'),
            aiLoading: document.getElementById('aiLoading'),
            aiLoadingText: document.getElementById('aiLoadingText')
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            attachEventListeners();
            console.log('🚀 Scanner IA Evatis initialisé');
        });

        async function initializeApp() {
            // Initialiser Tesseract worker
            elements.aiLoading.classList.add('active');
            elements.aiLoadingText.textContent = 'Initialisation IA Tesseract...';
            
            try {
                worker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = Math.round(m.progress * 100);
                            elements.aiLoadingText.textContent = `IA en cours... ${progress}%`;
                        }
                    }
                });
                
                // Configuration optimisée pour chiffres
                await worker.setParameters({
                    tessedit_char_whitelist: '0123456789',
                    tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                    tessedit_ocr_engine_mode: Tesseract.OEM.LSTM_ONLY
                });
                
                elements.aiLoading.classList.remove('active');
                showStatus('🤖 IA Tesseract prête - Détection ultra-précise!', 'success');
                
            } catch (error) {
                console.error('❌ Erreur init IA:', error);
                elements.aiLoading.classList.remove('active');
                showStatus('❌ Erreur chargement IA. Mode manuel disponible.', 'error');
            }
        }

        // Utilitaires
        function showStatus(message, type = 'processing', duration = 3000) {
            elements.status.textContent = message;
            elements.status.className = `status active ${type}`;
            
            if (duration > 0) {
                setTimeout(() => {
                    elements.status.classList.remove('active');
                }, duration);
            }
        }

        function vibrate(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        function toggleElement(element, show) {
            if (show) {
                element.classList.remove('hidden');
            } else {
                element.classList.add('hidden');
            }
        }

        // GESTION CAMÉRA
        async function startCamera() {
            try {
                showStatus('🚀 Démarrage caméra IA...', 'processing');
                
                const constraints = {
                    video: {
                        facingMode: { exact: 'environment' },
                        width: { ideal: 1920, min: 1280 },
                        height: { ideal: 1080, min: 720 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                };

                try {
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (error) {
                    console.log('❌ Fallback caméra...');
                    const fallbackConstraints = {
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };
                    stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                }

                elements.video.srcObject = stream;
                elements.video.setAttribute('playsinline', 'true');
                elements.video.setAttribute('webkit-playsinline', 'true');
                elements.video.muted = true;
                
                await elements.video.play();

                cameraActive = true;
                elements.cameraContainer.classList.add('active');
                
                toggleElement(elements.startCameraBtn, false);
                toggleElement(elements.autoScanBtn, true);
                toggleElement(elements.stopScanBtn, true);
                
                // Démarrer scan automatique
                if (autoScanActive && worker) {
                    startAutoScan();
                }
                
                showStatus('✅ Scan IA actif - Positionnez votre carte', 'success');
                vibrate(50);

            } catch (error) {
                console.error('❌ Erreur caméra:', error);
                
                const errorMessages = {
                    'NotAllowedError': '❌ Veuillez autoriser l\'accès à la caméra',
                    'NotFoundError': '❌ Aucune caméra trouvée',
                    'NotSupportedError': '❌ Caméra non supportée'
                };

                const message = errorMessages[error.name] || `❌ Erreur: ${error.message}`;
                showStatus(message, 'error', 0);
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (scanningInterval) {
                clearInterval(scanningInterval);
                scanningInterval = null;
            }
            
            cameraActive = false;
            elements.cameraContainer.classList.remove('active');
            elements.overlay.className = 'overlay';
            
            toggleElement(elements.startCameraBtn, true);
            toggleElement(elements.autoScanBtn, false);
            toggleElement(elements.stopScanBtn, false);
            
            showStatus('⏹️ Scanner arrêté', 'processing');
        }

        // SCAN AUTOMATIQUE INTELLIGENT
        function startAutoScan() {
            if (!worker || !cameraActive) return;
            
            elements.overlayText.textContent = '🤖 Scan IA en cours...';
            elements.overlay.className = 'overlay detecting';
            showStatus('🤖 IA en recherche de chiffres...', 'detecting', 0);
            
            // Scanner toutes les 2 secondes
            scanningInterval = setInterval(() => {
                if (!isProcessing && cameraActive) {
                    scanCurrentFrame();
                }
            }, 2000);
        }

        async function scanCurrentFrame() {
            if (isProcessing || !worker) return;
            
            try {
                isProcessing = true;
                
                // Capturer frame actuelle
                const ctx = elements.canvas.getContext('2d');
                elements.canvas.width = elements.video.videoWidth || 1280;
                elements.canvas.height = elements.video.videoHeight || 720;
                
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(elements.video, 0, 0);
                
                // Préprocessing pour améliorer la détection
                const imageData = ctx.getImageData(0, 0, elements.canvas.width, elements.canvas.height);
                preprocessImage(imageData);
                ctx.putImageData(imageData, 0, 0);
                
                // OCR avec Tesseract
                const result = await worker.recognize(elements.canvas);
                const extractedText = result.data.text.replace(/\D/g, '');
                const confidence = result.data.confidence;
                
                console.log('🔍 Scan result:', extractedText, 'Confidence:', confidence);
                
                // Si on trouve exactement 12 chiffres avec bonne confiance
                if (extractedText.length >= 12 && confidence > 60) {
                    const code = extractedText.substring(0, 12);
                    
                    // Animation de succès
                    elements.overlay.className = 'overlay found';
                    elements.overlayText.textContent = '✅ Code détecté!';
                    
                    // Arrêter le scan
                    clearInterval(scanningInterval);
                    stopCamera();
                    
                    // Afficher résultat
                    displayResult(code, confidence);
                    
                    vibrate([100, 50, 100, 50, 200]);
                    
                } else if (extractedText.length > 0) {
                    // Chiffres partiels détectés
                    elements.overlayText.textContent = `🔍 ${extractedText.length}/12 chiffres...`;
                    console.log('🔍 Chiffres partiels:', extractedText);
                }
                
            } catch (error) {
                console.error('❌ Erreur scan:', error);
            } finally {
                isProcessing = false;
            }
        }

        // Amélioration d'image pour OCR
        function preprocessImage(imageData) {
            const data = imageData.data;
            
            for (let i = 0; i < data.length; i += 4) {
                // Conversion en niveaux de gris
                const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
                
                // Amélioration contraste
                const contrast = gray > 128 ? 255 : 0;
                
                data[i] = contrast;     // R
                data[i + 1] = contrast; // G
                data[i + 2] = contrast; // B
            }
        }

        function displayResult(code, confidence) {
            detectedCodeValue = code;
            elements.detectedCode.textContent = code;
            
            // Barre de confiance
            elements.confidenceFill.style.width = `${confidence}%`;
            elements.confidenceText.textContent = `Confiance: ${Math.round(confidence)}%`;
            
            elements.result.classList.add('active');
            
            showStatus(`✅ Code détecté avec ${Math.round(confidence)}% de confiance!`, 'success');
            
            // APPEL AUTOMATIQUE
            startAutoCall();
        }

        // APPEL AUTOMATIQUE
        function startAutoCall() {
            elements.autoCallNotification.classList.add('active');
            let timeLeft = 3;
            
            const countdownInterval = setInterval(() => {
                elements.countdown.textContent = timeLeft;
                timeLeft--;
                
                if (timeLeft < 0) {
                    clearInterval(countdownInterval);
                    elements.autoCallNotification.classList.remove('active');
                    makeCall();
                }
            }, 1000);
            
            // Annuler en cliquant
            elements.autoCallNotification.onclick = () => {
                clearInterval(countdownInterval);
                elements.autoCallNotification.classList.remove('active');
                showStatus('⏹️ Appel automatique annulé', 'error');
            };
        }

        function toggleAutoScan() {
            autoScanActive = !autoScanActive;
            elements.autoScanBtn.textContent = autoScanActive ? 
                '🤖 Scan Automatique IA (ON)' : 
                '🤖 Scan Automatique IA (OFF)';
            
            if (cameraActive) {
                if (autoScanActive && worker) {
                    startAutoScan();
                } else {
                    if (scanningInterval) {
                        clearInterval(scanningInterval);
                    }
                    elements.overlay.className = 'overlay';
                    elements.overlayText.textContent = '📱 Mode manuel - Scan désactivé';
                }
            }
        }

        // Gestion saisie manuelle
        function toggleManualInput() {
            const isActive = elements.manualInput.classList.contains('active');
            
            if (isActive) {
                elements.manualInput.classList.remove('active');
            } else {
                elements.manualInput.classList.add('active');
                elements.manualCode.value = '';
                elements.manualCode.focus();
            }
        }

        function validateManualInput() {
            const value = elements.manualCode.value.replace(/\D/g, '').substring(0, 12);
            elements.manualCode.value = value;
            elements.useManualBtn.disabled = value.length !== 12;
        }

        function useManualCode() {
            const code = elements.manualCode.value;
            displayResult(code, 100); // 100% confiance pour saisie manuelle
            elements.manualInput.classList.remove('active');
        }

        // Actions
        function makeCall() {
            const phoneNumber = `*166*${detectedCodeValue}#`;
            console.log('📞 Appel:', phoneNumber);
            
            try {
                window.location.href = `tel:${phoneNumber}`;
                showStatus('📞 Ouverture téléphone...', 'success');
                vibrate(200);
            } catch (error) {
                showStatus('❌ Impossible d\'ouvrir téléphone', 'error');
            }
        }

        async function copyCode() {
            try {
                await navigator.clipboard.writeText(detectedCodeValue);
                showStatus('📋 Code copié!', 'success');
                vibrate(50);
            } catch (error) {
                showStatus('❌ Erreur de copie', 'error');
            }
        }

        // Event Listeners
        function attachEventListeners() {
            elements.startCameraBtn.onclick = startCamera;
            elements.autoScanBtn.onclick = toggleAutoScan;
            elements.stopScanBtn.onclick = stopCamera;
            elements.manualBtn.onclick = toggleManualInput;
            elements.manualCode.oninput = validateManualInput;
            elements.useManualBtn.onclick = useManualCode;
            elements.callBtn.onclick = makeCall;
            elements.copyBtn.onclick = copyCode;
            
            // Raccourcis clavier
            document.addEventListener('keydown', e => {
                if (e.key === 'Enter' && elements.manualInput.classList.contains('active')) {
                    if (!elements.useManualBtn.disabled) useManualCode();
                }
            });
        }

        // Nettoyage
        window.addEventListener('beforeunload', () => {
            if (worker) {
                worker.terminate();
            }
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>